<!doctype html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <link href="./style.css" rel="stylesheet" type="text/css">

    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <script>
        document.documentElement.style.setProperty(
            '--vh',
            window.innerHeight * 0.01 + 'px'
        )
    </script>
    <script>
        AFRAME.registerComponent('model-relative-opacity', {
            schema: { opacityFactor: { default: 1.0 } },
            init: function () {
                this.nodeMap = {}
                this.prepareMap.bind(this)
                this.traverseMesh.bind(this)

                this.el.addEventListener('model-loaded', e => {
                    this.prepareMap()
                    this.update()
                });
            },
            prepareMap: function () {
                this.traverseMesh(node => {
                    this.nodeMap[node.uuid] = node.material.opacity
                })
            },
            update: function () {
                this.traverseMesh(node => {
                    node.material.opacity = this.nodeMap[node.uuid] * this.data.opacityFactor
                    node.material.transparent = node.material.opacity < 1.0; node.material.needsUpdate = true;
                })
            }, remove: function () {
                this.traverseMesh(node => {
                    node.material.opacity = this.nodeMap[node.uuid]
                    node.material.transparent = node.material.opacity < 1.0; node.material.needsUpdate = true;
                })
            }, traverseMesh:
                function (func) {
                    var mesh = this.el.getObject3D('mesh'); if (!mesh) { return; } mesh.traverse(node => {
                        if (node.isMesh) {
                            func(node)
                        }
                    });
                }
        });
    </script>
    <script>
        var loaded = false;
        var first_markerfound = false;

        AFRAME.registerComponent('markerhandler', {
            init: function () {
                let aim = document.querySelector(".aim");
                var mars = document.querySelector("#mars");
                var bgmusic = document.querySelector('audio');

                this.el.addEventListener('markerFound', () => {
                    // alert("marker found!!");
                    aim.setAttribute('visible', true);
                    bgmusic.play();

                    if (!first_markerfound) {
                        first_markerfound = true;
                    }

                    if (first_markerfound && loaded) {
                        mars.emit("fadein");
                    }

                })
            }
        });
    </script>
    <script>
        AFRAME.registerComponent('marsmodel', {
            init: function () {
                let walker = document.querySelectorAll(".clickable");

                this.el.addEventListener('animationcomplete', () => {
                    for (i = 0; i < walker.length; i++) {
                        walker[i].setAttribute('visible', true);
                        loaded = false;
                    }
                })

                this.el.addEventListener('model-loaded', () => {
                    // alert("loaded!!");
                    if (!loaded) {
                        loaded = true;
                    }
                    if (loaded && first_markerfound) {
                        mars.emit("fadein");
                    }
                })
            }
        });
    </script>
    <script>
        AFRAME.registerComponent('walker', {
            schema: { index: { default: 0 } },
            init: function () {
                let walker_img = document.querySelectorAll("a-image");
                let img_component = document.querySelectorAll(".img_component");
                let blank = document.querySelector("#blank");
                let component_page = document.querySelector("#component-page");

                this.el.addEventListener('click', () => {
                    // alert(`${this.data.index} Click!!`);
                    mars.emit("walker-clicked");
                    walker_img[this.data.index].emit("clicked");
                    component_page.style.display = "block";
                    img_component[this.data.index].style.display = "block";
                })

                blank.addEventListener('click', () => {
                    mars.emit("blank-clicked");
                    component_page.style.display = "none";
                    img_component[this.data.index].style.display = "none";

                })
            }
        });
    </script>
    <title>world class AR</title>
</head>



<body style='margin : 0px; overflow: hidden;'>

    <a-scene arjs embedded renderer="logarithmicDepthBuffer: true;" vr-mode-ui="enabled: false">
        <a-entity camera>
            <a-entity position="0 0 -1" class="aim" visible="false" geometry="primitive: circle; radius: 0.002"
                material="color: white;" cursor=" fuse: false; rayOrigin:entity;" raycaster="objects: .clickable;">
            </a-entity>
        </a-entity>
        <a-assets>
            <img id="walker" src="assets/walker.png">
        </a-assets>
        <a-marker emitevents="true" markerhandler type='pattern' url='assets/pattern-marker.patt'>
            <!-- mars -->

            <a-entity id="mars" class="first-markerfound" marsmodel gltf-model=" url(assets/scene.gltf)"
                scale="0.8 0.8 0.8" position="0 0 0" model-relative-opacity
                animation="property: model-relative-opacity.opacityFactor; from: 0; to: 1; startEvents: fadein;  dur: 3000"
                animation__2="property: rotation; to: 0 360 0; loop: true; dur: 6000; pauseEvents: walker-clicked; resumeEvents: blank-clicked; easing: linear">

                <a-entity walker="index: 0" class="clickable" geometry="primitive: sphere; radius: 0.25;"
                    material="opacity: 0.0; transparent: true" visible="false" position="0 1.56 0.71">
                    <!-- <a-entity line="start: 0 0 0; end: 5 0 0; color: purple"
                        line__2="start: 0 0 0; end: 0 5 0; color: orange"
                        line__3="start: 0 0 0; end: 0 0 5; color: pink">
                    </a-entity> -->
                    <a-image src="#walker" material="opacity: 1;"
                        animation="property: material.opacity; from: 1; to: 0.4; startEvents: clicked; dur: 1"
                        height="0.375" width="0.25" position="0 0 0" rotation="315 0 0">
                    </a-image>
                </a-entity>

                <a-entity walker="index: 1" class="clickable" geometry="primitive: sphere; radius: 0.25"
                    material="opacity: 0.0; transparent: true" visible="false" position="1.01 1 0" rotation="0 90 0">
                    <a-image src="#walker" material="opacity: 1;" height="0.375" width="0.25" position="0 0 0"
                        animation="property: material.opacity; from: 1; to: 0.4; startEvents: clicked; dur: 1"
                        rotation="0 0 0">
                    </a-image>
                </a-entity>

                <a-entity walker="index: 2" class="clickable" geometry="primitive: sphere; radius: 0.25;"
                    material="opacity: 0.0; transparent: true" visible="false" position="0 1.82 -0.2"
                    rotation="0 180 0">
                    <a-image src="#walker" material="opacity: 1;" height="0.375" width="0.25" position="0 0 0"
                        animation="property: material.opacity; from: 1; to: 0.4; startEvents: clicked; dur: 1"
                        rotation="285 0 0">
                    </a-image>
                </a-entity>

                <a-entity walker="index: 3" class="clickable" geometry="primitive: sphere; radius: 0.25;"
                    material="opacity: 0.0; transparent: true" visible="false" position="-0.88 1.3 -0.2"
                    rotation="0 250 0">
                    <a-image src="#walker" material="opacity: 1;" height="0.375" width="0.25" position="0 0 0"
                        animation="property: material.opacity; from: 1; to: 0.4; startEvents: clicked; dur: 1"
                        rotation="330 0 0">
                    </a-image>
                </a-entity>
            </a-entity>

            <!-- draw axis -->
            <!-- <a-entity line="start: 0 0 0; end: 5 0 0; color: red" line__2="start: 0 0 0; end: 0 5 0; color: green"
                line__3="start: 0 0 0; end: 0 0 5; color: blue">
            </a-entity> -->
        </a-marker>
    </a-scene>
    <audio src="assets/Universe__Loop_.mp3" controls autoplay loop>
        <p>If you are reading this, it is because your browser does not support the audio element. </p>
    </audio>


    <div id="component-page">
        <div id="blank"></div>
        <img class="img_component" src="assets/fish_sauce.png">
        <img class="img_component" src="assets/caviar.png">
        <img class="img_component" src="assets/pickle.png">
        <img class="img_component" src="assets/olive.png">
    </div>

    <!-- <audio autoplay loop muted>
        <source src="assets/Universe__Loop_.mp3" type="audio/mpeg">
    </audio> -->
</body>